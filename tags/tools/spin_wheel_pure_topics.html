<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spin Wheel (URL Sync, Physics)</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f172a; --fg:#e6ebff; --muted:#9fb0d3; --brand:#7aa2ff; --border:rgba(255,255,255,.08);
    --accent:#a5b4fc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0c1330,transparent)}
  header h1{margin:0;font-size:18px;letter-spacing:.02em}
  .hint{color:var(--muted);font-size:12px}
  .wrap{display:grid;grid-template-columns:1fr 360px;gap:14px;max-width:1100px;margin:18px auto;padding:0 14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
  .canvasWrap{position:relative;max-width:640px;margin:0 auto}
  .canvasWrap::before{content:"";display:block;padding-top:100%}
  .canvasWrap > canvas{position:absolute;inset:0;width:100%;height:100%}
.pointer{
  position:absolute;left:50%;top:-2px;transform:translateX(-50%);
  width:0;height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-top:24px solid #ffd166;
  z-index:10;
}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
  button{cursor:pointer;border-radius:12px;border:1px solid var(--border);padding:10px 14px;background:transparent;color:var(--fg);font-weight:700}
  button.primary{background:var(--brand);border:0;color:#081127}
  button:disabled{opacity:.6;cursor:not-allowed}
  input[type=text],input[type=number]{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg)}
  input[type=checkbox]{transform:scale(1.1)}
  .row{display:grid;grid-template-columns:1fr 90px 76px 28px;gap:8px;align-items:center}
  .row+.row{margin-top:8px}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .flex{display:flex;gap:8px;align-items:center}
  .stat{margin-top:8px;text-align:center}
  .badge{display:inline-block;background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px}
  .hr{height:1px;background:var(--border);margin:12px 0}
  .optHead{display:grid;grid-template-columns:1fr 90px 76px 28px;gap:8px;margin-bottom:8px;color:var(--muted);font-size:12px}
  .footer{color:var(--muted);font-size:12px;text-align:center;margin:10px 0}
  #err{position:fixed;left:12px;bottom:12px;background:#3b0a0a;color:#ffd8d8;border:1px solid #b33;padding:10px 12px;border-radius:10px;max-width:90%;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;display:none;white-space:pre-wrap}
  @media (max-width:980px){ .wrap{grid-template-columns:1fr} }
</style>
</head>
<body>
<noscript><div style="padding:12px;background:#3b0a0a;color:#ffd8d8">This page needs JavaScript enabled.</div></noscript>

<header>
  <h1>Spin Wheel</h1>
  <div class="flex">
    <button id="shareUrlBtn" title="Copy a shareable link">Share</button>
    <span class="hint">URL auto-synced</span>
  </div>
</header>

<div class="wrap">
  <!-- Wheel -->
  <section class="card">
    <div class="canvasWrap">
      <div class="pointer" aria-hidden="true"></div>
      <canvas id="wheel" width="900" height="900">Canvas not supported.</canvas>
    </div>
    <div class="controls">
      <button class="primary" id="spinBtn">SPIN</button>
      <div class="flex">
        <label class="small muted">禁用最近 N 次重复：</label>
        <input id="recentN" type="number" min="0" max="20" step="1" style="width:80px">
      </div>
      <span id="result" class="badge">—</span>
    </div>
    <div class="stat small muted" id="stat"></div>
  </section>

  <!-- Config -->
  <aside class="card">
    <div class="flex" style="justify-content:space-between">
      <strong>Options</strong>
      <button id="addBtn">+ Add</button>
    </div>
    <div class="hr"></div>
    <div class="optHead"><div>Text</div><div>Weight</div><div>Enabled</div><div></div></div>
    <div id="list"></div>
    <div class="hr"></div>
    <div class="small muted">
      Tips:
      <ul>
        <li>Weight = 概率权重（相对值）</li>
        <li>禁用最近 N：优先避免重复；若可选项不足，会自动放宽</li>
        <li>分享按钮会复制带状态的链接（?s=…）</li>
      </ul>
    </div>
  </aside>
</div>

<div class="footer">Pure HTML/JS · works on GitHub Pages</div>
<div id="err"></div>

<script>
/* ===== error surface ===== */
(function(){
  function showErr(msg){ var el=document.getElementById('err'); el.style.display='block'; el.textContent=msg; }
  window.addEventListener('error', function(e){ showErr('Error: '+e.message); });
  window.addEventListener('unhandledrejection', function(e){ showErr('Promise rejection: '+(e.reason && e.reason.message || e.reason)); });
})();

/* ===== state & helpers ===== */
var TAU = Math.PI*2;
function $(sel){ return document.querySelector(sel); }
var canvas = $('#wheel');
var ctx = canvas.getContext && canvas.getContext('2d');
if(!ctx){ var _e=document.getElementById('err'); _e.style.display='block'; _e.textContent='Canvas context unavailable.'; }

var state = {
  options: [
    {text:'Coffee', weight:1, disabled:false},
    {text:'Tea',    weight:1, disabled:false},
    {text:'Juice',  weight:1, disabled:false},
    {text:'Water',  weight:1, disabled:false}
  ],
  recentLimit: 2,
  history: []
};
var listeners = [];
function onStateChange(cb){ listeners.push(cb); }
function notify(){ for(var i=0;i<listeners.length;i++) try{listeners[i]();}catch(_e){} }
function clone(obj){ return JSON.parse(JSON.stringify(obj||{})); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

function getState(){ return clone(state); }
function setState(s){
  try{
    if (!s || typeof s!=='object') return;
    if (Object.prototype.toString.call(s.options)==='[object Array]'){
      var arr=[], i;
      for(i=0;i<s.options.length;i++){
        var o=s.options[i]||{};
        arr.push({
          text: String(o.text||'').slice(0,120),
          weight: Math.max(0, Number(o.weight||1) || 0),
          disabled: !!o.disabled
        });
      }
      state.options = arr;
    }
    if (isFinite(s.recentLimit)) state.recentLimit = Math.max(0, Math.min(20, s.recentLimit|0));
    if (Object.prototype.toString.call(s.history)==='[object Array]') state.history = s.history.slice(-Math.max(0, state.recentLimit));
    renderList();
    afterEdit();
    $('#recentN').value = state.recentLimit;
    updateStat();
  }catch(e){ var er=document.getElementById('err'); er.style.display='block'; er.textContent='setState error: '+e.message; }
}

/* ===== UI list ===== */
function renderList(){
  var wrap = $('#list'); wrap.innerHTML='';
  for (var idx=0; idx<state.options.length; idx++){
    (function(idx){
      var o = state.options[idx];
      var row = document.createElement('div'); row.className='row';
      row.innerHTML =
        '<input type="text" value="'+escapeHtml(o.text)+'" aria-label="text">' +
        '<input type="number" min="0" step="0.1" value="'+o.weight+'" aria-label="weight">' +
        '<label class="flex" style="gap:6px;justify-content:center"><input type="checkbox" '+(o.disabled?'':'checked')+'><span class="small muted">'+(o.disabled?'Off':'On')+'</span></label>' +
        '<button title="Remove">✕</button>';
      var txt = row.children[0], w = row.children[1], chk = row.children[2], del = row.children[3];
      txt.addEventListener('input', function(){ o.text = txt.value; afterEdit(); });
      w.addEventListener('input',   function(){ var v = Number(w.value)||0; o.weight = v<0?0:v; updateStat(); afterEdit(); });
      chk.querySelector('input').addEventListener('change', function(e){ o.disabled = !e.target.checked; updateStat(); afterEdit(); });
      del.addEventListener('click', function(){ state.options.splice(idx,1); renderList(); afterEdit(); });
      wrap.appendChild(row);
    })(idx);
  }
}
$('#addBtn').addEventListener('click', function(){
  state.options.push({text:'Item '+(state.options.length+1), weight:1, disabled:false});
  renderList(); afterEdit();
});
$('#recentN').addEventListener('input', function(){
  var v = Number($('#recentN').value)||0; if(v<0)v=0; if(v>20)v=20;
  state.recentLimit = v;
  state.history = state.history.slice(-v);
  notify();
});

/* ===== drawing helpers ===== */
function sliceColor(i){
  var hues=[220,260,190,30,340,170,10,300,130,280];
  var h=hues[i%hues.length], l= i%2? 58:45, s= 65;
  return 'hsl('+h+' '+s+'% '+l+'%)';
}
function wrapText(ctx, text, r, lineH, maxLines){
  var words = String(text).split(/\s+/), line='', lines=[], i;
  for (i=0;i<words.length;i++){
    var w = words[i], test=line? (line+' '+w):w;
    if (ctx.measureText(test).width > r*0.9 && line) {
      lines.push(line); line=w;
      if (lines.length>=maxLines-1) break;
    } else line=test;
  }
  lines.push(line);
  for (i=0;i<lines.length;i++){
    ctx.fillText(lines[i], r, i*lineH - ((lines.length-1)*lineH)/2);
  }
}

/* ===== arcs + physics spin ===== */
var ARCS = []; // [{start,end,text,weight}]
var spinning=false, currentAngle=0;

function recomputeArcs(){
  ARCS = [];
  var active = [], i;
  for(i=0;i<state.options.length;i++){
    var o = state.options[i];
    if (!o.disabled && (o.weight||0) > 0) active.push({ text:o.text, weight:o.weight });
  }
  var total = 0; for (i=0;i<active.length;i++) total += active[i].weight;
  if (total <= 0 || active.length === 0) return;

  var a0 = -Math.PI/2; // pointer at top
  for (i=0;i<active.length;i++){
    var frac = active[i].weight / total;
    var a1 = a0 + TAU*frac;
    ARCS.push({ start:a0, end:a1, text:active[i].text, weight:active[i].weight });
    a0 = a1;
  }
}

function drawWheel(angle){
  if(!ctx) return;
  if (!ARCS.length) recomputeArcs();

  var W = canvas.width, H = canvas.height, R = Math.min(W,H)/2 - 8;
  ctx.save();
  ctx.clearRect(0,0,W,H);
  ctx.translate(W/2,H/2);
  ctx.rotate(angle||0);

  for (var i=0;i<ARCS.length;i++){
    var seg = ARCS[i];

    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,R,seg.start,seg.end,false);
    ctx.closePath();
    ctx.fillStyle = sliceColor(i);
    ctx.fill();
    ctx.lineWidth = 1.5;
    ctx.strokeStyle = 'rgba(255,255,255,.12)';
    ctx.stroke();

    var mid = (seg.start+seg.end)/2;
    ctx.save();
    ctx.rotate(mid);
    ctx.textAlign='right';
    ctx.fillStyle='#fff';
    ctx.font='16px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
    wrapText(ctx, seg.text, R-10, 18, 3);
    ctx.restore();
  }

  ctx.restore();
}

function normalizeAngle(a){ a%=TAU; if(a<0) a+=TAU; return a; }

function findArcUnderPointer(finalAngle){
  // pointer → top. After rotation by finalAngle, pointer maps to wheel angle:
  var pointerAngle = normalizeAngle(Math.PI*1.5 - (finalAngle % TAU));
  for (var i=0;i<ARCS.length;i++){
    var s = normalizeAngle(ARCS[i].start);
    var e = normalizeAngle(ARCS[i].end);
    if (s <= e) { if (pointerAngle >= s && pointerAngle < e) return ARCS[i]; }
    else { if (pointerAngle >= s || pointerAngle < e) return ARCS[i]; }
  }
  return ARCS[ARCS.length-1] || null;
}

function pickWeightedText(){
  var recent = {};
  var start = Math.max(0, state.history.length - state.recentLimit);
  for (var i=start;i<state.history.length;i++) recent[state.history[i]] = true;

  var c = [], total = 0, j;
  for (j=0;j<ARCS.length;j++){
    if (!recent[ARCS[j].text]) { c.push(ARCS[j]); total += ARCS[j].weight; }
  }
  if (!c.length){
    for (j=0;j<ARCS.length;j++){ c.push(ARCS[j]); total += ARCS[j].weight; }
  }
  if (!c.length) return null;

  var r = Math.random()*total;
  for (j=0;j<c.length;j++){ r-=c[j].weight; if (r<=0) return c[j].text; }
  return c[c.length-1].text;
}

/* --- physics spin: θ(t)=θ0 + ω0 t − 0.5 α t^2, stop at t=T (ω=0) --- */
function spinOnce(){
  if (spinning) return;

  recomputeArcs();
  if (!ARCS.length){ shake($('#spinBtn')); return; }

  // 1) choose winner (respect weight + recent rule)
  var winnerText = pickWeightedText();
  if (!winnerText){ shake($('#spinBtn')); return; }

  // 2) pick target segment and a point INSIDE the segment (avoid border)
  var seg=null, i;
  for (i=0;i<ARCS.length;i++){ if (ARCS[i].text===winnerText){ seg=ARCS[i]; break; } }
  if(!seg) seg = ARCS[0];
  var span = seg.end - seg.start;
  var margin = Math.min(0.2, span*0.2);               // keep 60%–80% inner area
  var targetAngle = seg.start + margin + Math.random()*(span - 2*margin);
  var desired = (Math.PI*1.5 - targetAngle);          // final wheel rotation so pointer hits target
  var base = normalizeAngle(desired - currentAngle);  // minimal positive rotation to target

  // 3) guarantee at least a few full circles (randomized)
  var minTurns = 3;                                   // ≥ 3 full circles
  var extraTurns = Math.floor(Math.random()*3);       // +0..2
  var deltaTheta = base + (minTurns + extraTurns)*TAU;

  // 4) choose a realistic duration randomly (2.8s ~ 4.5s)
  var T = (2800 + Math.random()*1700) / 1000;         // seconds

  // 5) solve physics: Δθ = 0.5 α T^2  =>  α = 2Δθ/T^2,  ω0 = α T
  var alpha = 2*deltaTheta / (T*T);
  var omega0 = alpha * T;

  // 6) animate
  var startA = currentAngle;
  var t0 = (performance && performance.now) ? performance.now() : Date.now();
  var durMs = T*1000;

  spinning = true; $('#spinBtn').disabled=true; $('#result').textContent='Spinning...';

  function step(now){
    now = (typeof now==='number') ? now : ((performance && performance.now) ? performance.now() : Date.now());
    var elapsed = (now - t0)/1000;  // s
    if (elapsed >= T){
      currentAngle = startA + deltaTheta; // snap exact
      drawWheel(currentAngle);
      spinning=false; $('#spinBtn').disabled=false;
      var finalSeg = findArcUnderPointer(currentAngle) || seg;
      var text = finalSeg.text;
      if (state.recentLimit>0){
        state.history.push(text);
        if (state.history.length>state.recentLimit){
          state.history = state.history.slice(-state.recentLimit);
        }
      }
      $('#result').textContent = '🎯 ' + text;
      notify();
      return;
    }
    var theta = startA + (omega0*elapsed) - 0.5*alpha*elapsed*elapsed;
    currentAngle = theta;
    drawWheel(currentAngle);
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
$('#spinBtn').addEventListener('click', spinOnce);

function shake(el){
  try{ el.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:300}); }catch(_e){}
}

function updateStat(){
  var total=0, i;
  for(i=0;i<state.options.length;i++){ var o=state.options[i]; if(!o.disabled) total+= (o.weight||0); }
  $('#stat').textContent = total>0 ? '总权重：'+total+'（仅统计启用项）' : '无可用选项';
}
function afterEdit(){
  recomputeArcs();
  drawWheel(currentAngle);
  updateStat();
  notify();
}

/* ===== URL Sync (compressed; ES5) ===== */
/* LZ codec (URI safe) – trimmed from lz-string */
var LZ = (function(){
  var keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";
  var baseReverseDic = {};
  function getBaseValue(alphabet, character){
    if(!baseReverseDic[alphabet]){
      baseReverseDic[alphabet] = {};
      for(var i=0;i<alphabet.length;i++) baseReverseDic[alphabet][alphabet.charAt(i)] = i;
    }
    return baseReverseDic[alphabet][character];
  }
  function enc(input){ if(input==null) return ""; return _compress(input, 6, function(a){ return keyStrUriSafe.charAt(a); }); }
  function _compress(uncompressed, bitsPerChar, getCharFromInt){
    if(uncompressed==null) return "";
    var i,value,context_dictionary={},context_dictionaryToCreate={},context_c="",context_wc="",context_w="",context_enlargeIn=2,context_dictSize=3,context_numBits=2,context_data=[],context_data_val=0,context_data_position=0,ii;
    for(ii=0;ii<uncompressed.length;ii++){
      context_c = uncompressed.charAt(ii);
      if(!Object.prototype.hasOwnProperty.call(context_dictionary,context_c)){ context_dictionary[context_c]=context_dictSize++; context_dictionaryToCreate[context_c]=true; }
      context_wc=context_w+context_c;
      if(Object.prototype.hasOwnProperty.call(context_dictionary,context_wc)) context_w=context_wc;
      else {
        if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){
          if(context_w.charCodeAt(0)<256){
            for(i=0;i<context_numBits;i++){ context_data_val=(context_data_val<<1); if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; }
            value=context_w.charCodeAt(0);
            for(i=0;i<8;i++){ context_data_val=(context_data_val<<1)|(value&1); if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; value=value>>1; }
          }else{
            value=1; for(i=0;i<context_numBits;i++){ context_data_val=(context_data_val<<1)|value&1; if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; value=0; }
            value=context_w.charCodeAt(0);
            for(i=0;i<16;i++){ context_data_val=(context_data_val<<1)|(value&1); if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; value=value>>1; }
          }
          context_enlargeIn--; if(context_enlargeIn==0){ context_enlargeIn=Math.pow(2,context_numBits); context_numBits++; }
          delete context_dictionaryToCreate[context_w];
        } else {
          value=context_dictionary[context_w];
          for(i=0;i<context_numBits;i++){ context_data_val=(context_data_val<<1)|(value&1); if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; value=value>>1; }
        }
        context_enlargeIn--; if(context_enlargeIn==0){ context_enlargeIn=Math.pow(2,context_numBits); context_numBits++; }
        context_dictionary[context_wc]=context_dictSize++; context_w=String(context_c);
      }
    }
    if(context_w!==""){
      if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){
        if(context_w.charCodeAt(0)<256){
          for(i=0;i<context_numBits;i++){ context_data_val=(context_data_val<<1); if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; }
          value=context_w.charCodeAt(0);
          for(i=0;i<8;i++){ context_data_val=(context_data_val<<1)|(value&1); if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; value=value>>1; }
        }else{
          value=1; for(i=0;i<context_numBits;i++){ context_data_val=(context_data_val<<1)|value&1; if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; value=0; }
          value=context_w.charCodeAt(0);
          for(i=0;i<16;i++){ context_data_val=(context_data_val<<1)|(value&1); if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; value=value>>1; }
        }
        context_enlargeIn--; if(context_enlargeIn==0){ context_enlargeIn=Math.pow(2,context_numBits); context_numBits++; }
        delete context_dictionaryToCreate[context_w];
      } else {
        value=context_dictionary[context_w];
        for(i=0;i<context_numBits;i++){ context_data_val=(context_data_val<<1)|(value&1); if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; value=value>>1; }
      }
      context_enlargeIn--; if(context_enlargeIn==0){ context_enlargeIn=Math.pow(2,context_numBits); context_numBits++; }
    }
    value=2; for(i=0;i<context_numBits;i++){ context_data_val=(context_data_val<<1)|(value&1); if(context_data_position==bitsPerChar-1){ context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++; value=value>>1; }
    while(true){ context_data_val=(context_data_val<<1); if(context_data_position==bitsPerChar-1){ context_data.push(getCharFromInt(context_data_val)); break; } else context_data_position++; }
    return context_data.join('');
  }
  function dec(input){
    if(input==null) return "";
    if(input==="") return null;
    input = input.replace(/ /g, '+');
    return _decompress(input.length, 32, function(idx){ return getBaseValue(keyStrUriSafe, input.charAt(idx)); });
  }
  function _decompress(length, resetValue, getNextValue){
    var dictionary = [0,1,2]; var enlargeIn=4, dictSize=4, numBits=3, entry, result=[], i,w,bits, resb, maxpower, power, c, data = {val:getNextValue(0), position:resetValue, index:1};
    function readBits(n){ bits=0; maxpower=Math.pow(2,n); power=1; while(power!=maxpower){ resb=data.val&data.position; data.position>>=1; if(data.position==0){ data.position=resetValue; data.val=getNextValue(data.index++); } bits|=(resb>0?1:0)*power; power<<=1; } return bits; }
    var next = readBits(2);
    switch(next){ case 0: c=String.fromCharCode(readBits(8)); break; case 1: c=String.fromCharCode(readBits(16)); break; case 2: return ""; }
    dictionary[3]=c; w=c; result.push(c);
    while(true){
      if(data.index>length) return "";
      var cc = readBits(numBits);
      switch(cc){
        case 0: c=String.fromCharCode(readBits(8)); dictionary[dictSize++]=c; cc=dictSize-1; enlargeIn--; break;
        case 1: c=String.fromCharCode(readBits(16)); dictionary[dictSize++]=c; cc=dictSize-1; enlargeIn--; break;
        case 2: return result.join('');
      }
      if(enlargeIn==0){ enlargeIn=Math.pow(2,numBits); numBits++; }
      if(dictionary[cc]) entry=dictionary[cc];
      else if(cc===dictSize) entry=w+w.charAt(0);
      else return null;
      result.push(entry); dictionary[dictSize++]=w+entry.charAt(0); enlargeIn--; w=entry;
      if(enlargeIn==0){ enlargeIn=Math.pow(2,numBits); numBits++; }
    }
  }
  return { enc:enc, dec:dec };
})();

var UrlSync = (function(){
  var KEY='s', VER=1;
  function encode(st){
    var arr=[], i, o;
    for(i=0;i<(st.options||[]).length;i++){
      o=st.options[i]||{};
      arr.push([o.text||'', Number(o.weight||1)||1, !!o.disabled]);
    }
    var payload = { v:VER, r: st.recentLimit|0, h: Array.isArray(st.history)? st.history.slice(-Math.max(0,st.recentLimit|0)) : [], o: arr };
    return LZ.enc(JSON.stringify(payload));
  }
  function decode(s){
    try{
      var j=LZ.dec(s); if(!j) return null;
      var p=JSON.parse(j); if(p.v!==VER) return null;
      var opts=[], i, a;
      for(i=0;i<(p.o||[]).length;i++){ a=p.o[i]||[]; opts.push({text:String(a[0]||''), weight:Number(a[1]||1)||1, disabled:!!a[2]}); }
      return { recentLimit:p.r|0, history:Array.isArray(p.h)?p.h:[], options:opts };
    }catch(e){ return null; }
  }
  function read(){ var u=new URL(location.href); var s=u.searchParams.get(KEY); return s? decode(s):null; }
  function write(st, cfg){ cfg=cfg||{}; var u=new URL(location.href); u.searchParams.set(KEY, encode(st)); if(cfg.replace!==false){ history.replaceState(null,'',u); } else { history.pushState(null,'',u); } return u.toString(); }
  return { read:read, write:write };
})();

/* ===== wire up + init ===== */
(function(){
  var incoming = UrlSync.read();
  if (incoming) setState(incoming); else setState(state);

  var urlTimer=null;
  onStateChange(function(){ clearTimeout(urlTimer); urlTimer=setTimeout(function(){ UrlSync.write(getState(), {replace:true}); }, 200); });

  var btn = document.getElementById('shareUrlBtn');
  if (btn){
    btn.addEventListener('click', function(){
      var link = UrlSync.write(getState(), {replace:true});
      if (navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(link).then(function(){
          btn.textContent='Link copied ✓';
          setTimeout(function(){ btn.textContent='Share'; }, 1000);
        }, function(){ prompt('Copy link:', link); });
      } else { prompt('Copy link:', link); }
    });
  }

  renderList();
  recomputeArcs();
  drawWheel(0);
  document.getElementById('recentN').value=state.recentLimit;
  updateStat();
})();

</script>
</body>
</html>
