<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Workspace</title>
  <meta name="description" content="Minimal personal toolkit with categorized posts and a beautiful layout." />
  <style>
    :root{
      --bg:#0b1020; --fg:#e6ebff; --muted:#9fb0d3; --card:#0f172a;
      --border:rgba(255,255,255,.08); --brand:#7aa2ff; --brand2:#7c3aed;
      --pill:#a5b4fc; --hover:rgba(122,162,255,.18); --link:#c7d2fe;
    }
    html[data-theme="light"]{
      --bg:#f7f8fb; --fg:#0f172a; --muted:#475569; --card:#ffffff;
      --border:#e5e7eb; --brand:#2563eb; --brand2:#7c3aed; --pill:#6366f1; --hover:#eef2ff; --link:#1e40af;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
      font: 16px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    .app{display:grid; grid-template-columns: 280px 1fr; min-height:100dvh;}
    @media (max-width: 1000px){ .app{grid-template-columns: 1fr;} .side{position:fixed; inset:64px 0 0 0; transform:translateX(-100%); transition:.25s transform ease; z-index:30} .side.open{transform:none} }
    .top{
      position:sticky; top:0; z-index:40;
      height:64px; display:flex; align-items:center; gap:12px; padding:0 16px;
      background: linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,0)) , var(--bg);
      border-bottom:1px solid var(--border);
      backdrop-filter: saturate(1.1) blur(6px);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; }
    .logo{ width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--brand),var(--brand2)); box-shadow:0 6px 20px rgba(124,58,237,.35); }
    .spacer{flex:1}
    .top .btn{border:1px solid var(--border); background:transparent; color:var(--fg); padding:8px 10px; border-radius:10px; cursor:pointer}
    .top .btn:hover{background:var(--hover)}
    .search{ display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:12px; background:transparent; }
    .search input{ border:0; outline:0; background:transparent; color:var(--fg); }

    /* Sidebar */
    .side{ border-right:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); padding:18px 12px; display:flex; flex-direction:column; gap:8px; }
    .navTitle{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.16em; padding:6px 10px}
    details{ border-radius:12px; margin:2px 6px; }
    summary{ list-style:none; cursor:pointer; padding:10px 12px; border-radius:12px; border:1px solid transparent; display:flex; align-items:center; gap:8px; }
    summary:hover{ background:var(--hover); border-color:var(--border); }
    details[open] summary{ background:linear-gradient(135deg, rgba(122,162,255,.18), rgba(124,58,237,.18)); border-color:var(--border) }
    .count{ margin-left:auto; font-size:12px; color:var(--pill); border:1px solid var(--border); border-radius:999px; padding:2px 8px; }
    .tagLinks{ padding:6px 10px 10px 22px; }
    .tagLinks a{ display:block; color:var(--link); text-decoration:none; padding:6px 8px; border-radius:8px; }
    .tagLinks a:hover{ background:var(--hover); }

    /* Main Grid */
    .main{ padding:22px; max-width:1200px; width:100%; margin:0 auto; }
    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:18px; }
    .card{ grid-column: span 12; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; position:relative; overflow:hidden }
    @media (min-width: 820px){ .half{ grid-column: span 6 } .third{ grid-column: span 4 } }
    .card h2{ margin:6px 0 6px; font-size:18px }
    .card p{ margin:6px 0 10px; color:var(--muted) }
    .tags{ display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px }
    .pill{ display:inline-block; font-size:12px; color:var(--pill); border:1px solid var(--border); padding:4px 8px; border-radius:999px; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap }
    .btn{ display:inline-flex; align-items:center; gap:10px; background:transparent; border:1px solid var(--border); color:var(--fg); padding:8px 12px; border-radius:12px; text-decoration:none; font-weight:700; }
    .btn:hover{ background:var(--hover) }
    footer{ margin-top:32px; color:var(--muted); font-size:12px; text-align:center }
    .hidden{ display:none !important }
  </style>
</head>
<body>
  <div class="app">
    <aside class="side" id="side">
      <div class="navTitle">Categories</div>
      <div id="catContainer"></div>
    </aside>

    <div>
      <div class="top">
        <button class="btn" id="menuBtn">‚ò∞</button>
        <div class="brand">
          <div class="logo"></div>
          <div>
            <div style="font-size:15px;opacity:.9">My Workspace</div>
            <div style="font-size:12px;color:var(--muted)">Minimal personal toolkit</div>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="search">
          üîé <input id="search" placeholder="Search..." />
        </div>
        <button id="themeBtn" class="btn" title="Toggle theme">‚òÄÔ∏è / üåô</button>
      </div>

      <main class="main">
        <div class="grid" id="grid"></div>
        <footer>¬© <span id="year"></span> ¬∑ Minimal template ¬∑ Built with plain HTML/CSS ¬∑ No frameworks</footer>
      </main>
    </div>
  </div>

  <script>
    // State and helpers
    const $ = (sel) => document.querySelector(sel);
    const grid = $('#grid');
    const catContainer = $('#catContainer');
    const searchInput = $('#search');
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) root.setAttribute('data-theme', savedTheme);
    $('#themeBtn').onclick = ()=>{
      const now = root.getAttribute('data-theme')==='light' ? 'dark' : 'light';
      root.setAttribute('data-theme', now); localStorage.setItem('theme', now);
    };
    document.getElementById('year').textContent = new Date().getFullYear();
    const side = document.getElementById('side'); const menuBtn = document.getElementById('menuBtn');
    menuBtn.onclick = ()=> side.classList.toggle('open');

    // Load content.json
    let POSTS = []; let TAGS = {}; // tag -> [{post},...]
    fetch('data/content.json').then(r=>r.json()).then(data=>{
      POSTS = data.posts || [];
      // Build tag map (use first tag as primary category)
      TAGS = {};
      POSTS.forEach(p=>{
        (p.tags||[]).forEach(tag=>{
          TAGS[tag] = TAGS[tag] || [];
          TAGS[tag].push(p);
        });
      });
      buildSidebar();
      renderCards();
      applyHashFilter();
    });

    function buildSidebar(){
      catContainer.innerHTML = '';
      const tags = Object.keys(TAGS).sort((a,b)=> a.localeCompare(b));
      tags.forEach(tag=>{
        const count = TAGS[tag].length;
        const d = document.createElement('details');
        d.open = false;
        const s = document.createElement('summary');
        s.innerHTML = `# ${tag} <span class=\"count\">${count}</span>`;
        d.appendChild(s);
        const box = document.createElement('div'); box.className='tagLinks';
        TAGS[tag].forEach(p=>{
          const a = document.createElement('a');
          a.href = p.url; a.textContent = p.title;
          box.appendChild(a);
        });
        d.appendChild(box);
        // clicking summary filters main grid by tag
        s.addEventListener('click', (e)=>{
          e.preventDefault();
          const isOpen = d.hasAttribute('open');
          // toggle open state
          if (isOpen) d.removeAttribute('open'); else d.setAttribute('open','');
          // filter grid
          location.hash = `tag=${encodeURIComponent(tag)}`;
          renderCards(tag, searchInput.value.trim());
        });
        catContainer.appendChild(d);
      });
    }

    function matchesSearch(p, q){
      if (!q) return true;
      const t = q.toLowerCase();
      return (p.title||'').toLowerCase().includes(t) || (p.desc||'').toLowerCase().includes(t) || (p.tags||[]).join(' ').toLowerCase().includes(t);
    }

    function renderCards(activeTag=null, query=''){
      grid.innerHTML = '';
      let posts = POSTS.slice();
      if (activeTag) posts = posts.filter(p => (p.tags||[]).includes(activeTag));
      if (query) posts = posts.filter(p => matchesSearch(p, query));
      // sort by date desc then title
      posts.sort((a,b)=> (b.date||'').localeCompare(a.date||'') || (a.title||'').localeCompare(b.title||''));
      posts.forEach(p=>{
        const card = document.createElement('section');
        card.className = 'card third';
        const tags = (p.tags||[]).map(t=>`<span class=\"pill\">#${t}</span>`).join(' ');
        const dl = (p.downloads||[]).map(d=>`<a class=\"btn\" href=\"${d.url}\">‚¨áÔ∏è ${d.label}</a>`).join(' ');
        card.innerHTML = `
          <div class=\"tags\">${tags}</div>
          <h2>${p.title}</h2>
          <p>${p.desc||''}</p>
          <div class=\"actions\">
            <a class=\"btn\" href=\"${p.url}\">Open</a>
            ${dl}
          </div>
        `;
        grid.appendChild(card);
      });
      if (!posts.length){
        const empty = document.createElement('div');
        empty.className='card'; empty.innerHTML = '<p style="margin:0;color:var(--muted)">No posts match your filter.</p>';
        grid.appendChild(empty);
      }
    }

    function applyHashFilter(){
      const h = location.hash || '';
      const m = h.match(/tag=([^&]+)/);
      const q = h.match(/q=([^&]+)/);
      const tag = m ? decodeURIComponent(m[1]) : null;
      const query = q ? decodeURIComponent(q[1]) : '';
      if (query) { searchInput.value = query; }
      renderCards(tag, query);
    }

    // search interaction
    searchInput.addEventListener('input', ()=>{
      const q = searchInput.value.trim();
      const h = new URLSearchParams(location.hash.slice(1));
      if (q) h.set('q', q); else h.delete('q');
      location.hash = h.toString();
      applyHashFilter();
    });
    window.addEventListener('hashchange', applyHashFilter);
  
    /* FULLTEXT: fetch & index article bodies */
    const FT_VER = 'v1';
    let FT_CACHE = JSON.parse(localStorage.getItem('ft_cache_'+FT_VER) || '{}');

    function stripHtml(html){
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      // remove script/style/nav/aside
      tmp.querySelectorAll('script,style,noscript,nav,aside').forEach(n=>n.remove());
      return (tmp.textContent || '').replace(/\s+/g,' ').trim();
    }
    async function fetchTextOnce(url){
      if (FT_CACHE[url]) return FT_CACHE[url];
      try{
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(res.statusText);
        const html = await res.text();
        const text = stripHtml(html);
        FT_CACHE[url] = text;
        localStorage.setItem('ft_cache_'+FT_VER, JSON.stringify(FT_CACHE));
        return text;
      }catch(e){ return ''; }
    }

    async function ensureFulltext(){
      // load after first query to save time
      const promises = POSTS.map(p => fetchTextOnce(p.url));
      await Promise.all(promises);
    }

    function scorePost(p, q){
      const t = q.toLowerCase();
      let score = 0;
      if ((p.title||'').toLowerCase().includes(t)) score += 5;
      if ((p.desc||'').toLowerCase().includes(t)) score += 2;
      if ((p.tags||[]).join(' ').toLowerCase().includes(t)) score += 2;
      const body = (FT_CACHE[p.url]||'').toLowerCase();
      const cnt = (body.match(new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length;
      score += Math.min(10, cnt); // cap body contribution
      return score;
    }

    async function doSearch(query, activeTag=null){
      if (!query){ renderCards(activeTag, ''); return; }
      await ensureFulltext();
      const t = query.trim();
      const posts = POSTS.filter(p => !activeTag || (p.tags||[]).includes(activeTag));
      posts.forEach(p => p._score = scorePost(p, t));
      posts.sort((a,b)=> (b._score||0) - (a._score||0) || (b.date||'').localeCompare(a.date||''));
      renderCardsFromList(posts);
    }

    function renderCardsFromList(list){
      grid.innerHTML = '';
      const items = list.slice();
      items.forEach(p=>{
        const card = document.createElement('section');
        card.className = 'card third';
        const tags = (p.tags||[]).map(t=>`<span class="pill">#${t}</span>`).join(' ');
        const dl = (p.downloads||[]).map(d=>`<a class="btn" href="${d.url}">‚¨áÔ∏è ${d.label}</a>`).join(' ');
        let snippet='';
        if (FT_CACHE[p.url]){
          const body = FT_CACHE[p.url];
          const idx = body.toLowerCase().indexOf(searchInput.value.toLowerCase());
          if (idx >= 0){
            const start = Math.max(0, idx - 60), end = Math.min(body.length, idx + 120);
            snippet = body.slice(start, end).replace(/</g,'&lt;').replace(/>/g,'&gt;');
          }
        }
        card.innerHTML = `
          <div class="tags">${tags}</div>
          <h2>${p.title}</h2>
          <p>${p.desc||''}</p>
          ${snippet ? `<p style="font-size:13px;color:var(--muted)">${snippet}‚Ä¶</p>` : ``}
          <div class="actions">
            <a class="btn" href="${p.url}">Open</a>
            ${dl}
          </div>
        `;
        grid.appendChild(card);
      });
      if (!items.length){
        const empty = document.createElement('div');
        empty.className='card'; empty.innerHTML = '<p style="margin:0;color:var(--muted)">No posts match your filter.</p>';
        grid.appendChild(empty);
      }
    }

    // Override search input handling to use fulltext
    searchInput.addEventListener('input', async ()=>{
      const q = searchInput.value.trim();
      const h = new URLSearchParams(location.hash.slice(1));
      if (q) h.set('q', q); else h.delete('q');
      location.hash = h.toString();
      const m = location.hash.match(/tag=([^&]+)/);
      const tag = m ? decodeURIComponent(m[1]) : null;
      if (q) await doSearch(q, tag); else renderCards(tag, '');
    });

    /* END FULLTEXT */
  </script>
</body>
</html>

</body>
</html>
